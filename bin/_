#!/usr/bin/env python3
import os
from threading import Thread

from bottle import Bottle, run, request, response

from _.retrieve import mailbox
from _.parse import parse

messages = {}
b = Bottle()

@b.get('/')
def root():
    response.set_header('Content-Language', 'en')
    response.set_header('Content-Type', 'application/json; charset=utf-8')
    response.status = 200
    return json.dumps(messages)

def main():
    emails = mailbox(host, username, password)
    t = Thread(None, target = receive_messages,
               name = 'receive', args = (emails, messages))
    run(b)

def receive_messages(emails, target:dict):
    for email in emails:
        message_id, date, subject, body = parse(email)
        target[message_id] = date, subject, body

if __name__ == '__main__':
    main()
